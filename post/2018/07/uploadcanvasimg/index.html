<!DOCTYPE html>
<html lang="zh-cn">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		
		
		<meta name="generator" content="Hugo 0.42.1" />
		<title>一键上传canvas所生成的图片至CDN &middot; 深樹博客</title>
		<link rel="dns-prefetch" href="https://deeptree.me" />
		<link rel="dns-prefetch" href="https://cdn.bootcss.com" />
		<link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />
		<link rel="shortcut icon" href="https://deeptree.me/images/favicon.ico">
		<link rel="stylesheet" href="https://deeptree.me/css/style.min.css">
		<link rel="stylesheet" href="https://deeptree.me/css/highlight.css">

		
		

		

		
	</head>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

    <body>
       <nav class="main-nav">
	
	
		<a href='https://deeptree.me/'> <span class="arrow">←</span>Home</a>
	
	<a href='https://deeptree.me/post'>Archive</a>
	<a href='https://deeptree.me/tags'>Tags</a>
	<a href='https://deeptree.me/about'>About</a>

	

	
</nav>


        <section id="wrapper" class="post">
            <article>
                <header>
                    <h1>
                        一键上传canvas所生成的图片至CDN
                    </h1>
                    <h2 class="headline">
                    Jul 17, 2018 17:47
                    · 87 words
                    · 1 minute read
                      <span class="tags">
                      
                      
                          
                              <a href="https://deeptree.me/tags/canvas">canvas</a>
                          
                      
                      
                      </span>
                    </h2>
                </header>
                
                  
                    <div id="toc">
                      <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#起因">起因</a></li>
<li><a href="#分析">分析</a></li>
<li><a href="#代码">代码</a></li>
</ul></li>
</ul>
</nav>
                    </div>
                  
                
                <section id="post-body">
                    

<h2 id="起因">起因</h2>

<p>最近在做动态生成海报的项目，有生成海报后上传当前canvas图片的需求。</p>

<h2 id="分析">分析</h2>

<p>脑袋一拍，思索出流程是这样canvas=&gt;base64=&gt;POST接口。但是常见的CDN不支持base64啊！查了下发现有<code>canvas.toBlob</code>（兼容性为Chrome50+）</p>

<p>于是流程改为canvas=&gt;blob=&gt;POST接口，但发现CDN还是不吃这一套，接口报错</p>

<p>思来想去，决定用普通的手动上传方式<code>&lt;input type=&quot;file&quot; /&gt;</code>看下请求格式（如图）</p>

<p><img src="../imgpost.png" alt="imgpost" /></p>

<p>从<code>Content-Type</code>可以看出需要使用FormData对象去上传</p>

<p>红框部分则是<code>&lt;input type=&quot;file&quot; /&gt;</code>所生成的</p>

<p>分析一通后，梳理流程为canvas=&gt;blob=&gt;File=&gt;FormData=&gt;POST</p>

<h2 id="代码">代码</h2>

<pre><code class="language-javascript">canvasInstance.toBlob(blob =&gt; {
  // blob转file
  const file = new File([blob], 'poster.png', {
    type: 'image/png',
    lastModified: Date.now()
  })
  const xhr = new XMLHttpRequest()
  xhr.onreadystatechange = () =&gt; {
    try {
      if (xhr.readyState === 4 &amp;&amp; xhr.status &gt;= 200 &amp;&amp; xhr.status &lt; 400) {
        const res = JSON.parse(xhr.responseText)
        console.log(res)
      }
    } catch (e) {
      console.log('e', e)
    }
  }
  xhr.open(
    'POST',
    `${cdnUrl}`,
    true
  )
  // 转换成通过input上传的文件
  let formData = new FormData()
  formData.append('file', file)
  xhr.send(formData)
}, 'image/png')
</code></pre>

                </section>
            </article>

            

            
            
            
            
            <ul id="post-list" class="archive readmore">
    <h3>Read more</h3>

    
    
    
        <li>
            <a href="/post/2018/06/passive/">addEventListener中的passive属性踩坑<aside class="dates">Jun 23 2018</aside></a>
        </li>
    
</ul>

            
            
            
                <div class="post-comments" id="gitalk-ctn"></div>
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script>
  var gitalk = new Gitalk({
    id: location.pathname,
    owner: 'spiritree',
    repo: 'blog',
    title: '一键上传canvas所生成的图片至CDN',
    body: 'https:\/\/deeptree.me\/post\/2018\/07\/uploadcanvasimg\/\n分析如何通过canvas生成图片并上传至CDN',
    labels: ["canvas"],
    clientID: '00a0202c161baf1e3c08',
    clientSecret: '205f6c77990b4e455ef793a28ae45b4506c40ddd',
    admin: ['spiritree']
  })
  gitalk.render('gitalk-ctn')
</script>
            
            
            <footer id="footer">
    
    <p class="small">
    
       © Copyright 2018 <i class="fa fa-heart" aria-hidden="true"></i> 
    
    </p>
    <p class="small">
        Powered by <a href="http://www.gohugo.io/">Hugo</a> Theme By <a href="https://github.com/nodejh/hugo-theme-cactus-plus">nodejh</a>
    </p>
</footer>

        </section>
        
        <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad()</script>






    </body>
</html>
